# Copier template configuration for Aegis Stack
# This replaces cookiecutter.json with more powerful features:
# - Questions with validation
# - Conditional questions
# - Better defaults
# - Update support

_min_copier_version: "9.0.0"
_version: "0.5.4"

# IMPORTANT: Template content is in subdirectory
# This allows the template to be recognized as git-tracked (aegis-stack repo root has .git)
# while keeping template files organized in aegis/templates/
_subdirectory: aegis/templates/copier-aegis-project

# Answers file to track component selections for updates
_answers_file: .copier-answers.yml

# Template directory name (Copier will generate {{project_slug}} directory automatically)
_templates_suffix: .jinja

# Project metadata
project_name:
  type: str
  help: "Name of your Aegis Stack project"
  default: "My Aegis Stack Project"

project_slug:
  type: str
  help: "Project slug (auto-generated from name)"
  default: "{{ project_name.lower().replace(' ', '-').replace('_', '-') }}"

project_description:
  type: str
  help: "Brief description of your project"
  default: "A production-ready async Python application built with Aegis Stack"

author_name:
  type: str
  help: "Your name"
  default: "Your Name"

author_email:
  type: str
  help: "Your email address"
  default: "your.email@example.com"

github_username:
  type: str
  help: "Your GitHub username"
  default: "your-username"

version:
  type: str
  help: "Initial version"
  default: "0.1.0"

aegis_version:
  type: str
  help: "Aegis Stack version (auto-injected)"
  default: "0.0.0"

python_version:
  type: str
  help: "Python version to use"
  default: "3.14"
  choices:
    - "3.11"
    - "3.12"
    - "3.13"
    - "3.14"

# Component selection
include_scheduler:
  type: bool
  help: "Include APScheduler for scheduled tasks?"
  default: false

include_redis:
  type: bool
  help: "Include Redis for caching and pub/sub?"
  default: false

include_worker:
  type: bool
  help: "Include worker for background jobs?"
  default: false

worker_backend:
  type: str
  help: "Worker backend (arq or taskiq)"
  default: "arq"
  choices:
    - "arq"
    - "taskiq"
  when: "{{ include_worker }}"

include_database:
  type: bool
  help: "Include SQLModel database?"
  default: false

database_engine:
  type: str
  help: "Database engine"
  default: "sqlite"
  choices:
    - "sqlite"
    - "postgres"
  # NOTE: No `when` clause - we need this value saved even when include_database=false
  # so that templates can conditionally render based on engine type

include_cache:
  type: bool
  help: "Include Redis cache component?"
  default: false

scheduler_backend:
  type: str
  help: "Scheduler backend storage"
  default: "memory"
  choices:
    - "memory"
    - "sqlite"
    - "postgres"
  when: "{{ include_scheduler }}"

scheduler_with_persistence:
  type: bool
  help: "Enable scheduler persistence?"
  default: "{{ scheduler_backend == 'sqlite' }}"
  when: "{{ include_scheduler }}"

# Service selection
include_auth:
  type: bool
  help: "Include authentication service with JWT?"
  default: false

include_ai:
  type: bool
  help: "Include AI service?"
  default: false

ai_framework:
  type: str
  help: "AI framework to use"
  default: "pydantic-ai"
  choices:
    - "pydantic-ai"
    - "langchain"
  when: "{{ include_ai }}"

ai_providers:
  type: str
  help: "AI providers to support (comma-separated)"
  default: "openai"
  when: "{{ include_ai }}"

ai_backend:
  type: str
  help: "AI conversation storage backend"
  default: "memory"
  choices:
    - "memory"
    - "sqlite"
    - "postgres"
  when: "{{ include_ai }}"

ai_with_persistence:
  type: bool
  help: "Enable AI conversation persistence?"
  default: "{{ ai_backend in ['sqlite', 'postgres'] }}"
  when: "{{ include_ai }}"

ai_rag:
  type: bool
  help: "Enable RAG (Retrieval-Augmented Generation) for document indexing?"
  default: false
  when: "{{ include_ai }}"

ollama_mode:
  type: str
  help: "Ollama deployment mode (host, docker, or none)"
  default: "none"
  choices:
    - "host"
    - "docker"
    - "none"
  # Note: No 'when' condition - always include for template access
  # Defaults to "none" when AI not using ollama

include_comms:
  type: bool
  help: "Include communications service (email/SMS)?"
  default: false

# Internal computed values (using Jinja2)
_has_additional_components: "{{ include_scheduler or include_redis or include_worker or include_database or include_cache }}"
_include_migrations: "{{ include_auth }}"

# Component-specific dependencies (computed)
_scheduler_deps: "{% if include_scheduler %}apscheduler>=3.10.0{% endif %}"
_redis_deps: "{% if include_redis %}redis>=5.0.0{% endif %}"
_worker_deps: "{% if include_worker %}arq>=0.25.0{% endif %}"
_database_deps: "{% if include_database %}sqlmodel>=0.0.14,sqlalchemy>=2.0.0{% if database_engine == 'sqlite' %},aiosqlite>=0.19.0{% endif %}{% if database_engine == 'postgres' %},asyncpg>=0.29.0,psycopg2-binary>=2.9.9{% endif %}{% endif %}"
_cache_deps: "{% if include_cache %}redis[hiredis]>=5.0.0{% endif %}"

# Service-specific dependencies (computed)
_auth_deps: "{% if include_auth %}python-jose[cryptography]==3.3.0,passlib[bcrypt]==1.7.4,python-multipart==0.0.9{% endif %}"
_ai_deps: "{% if include_ai %}pydantic-ai-slim[{{ ai_providers }}]==1.0.10,httpx>=0.27.0{% endif %}"

# NOTE: _tasks have been removed - post-generation tasks are now handled by
# aegis/core/post_gen_tasks.py which is called from:
# - Cookiecutter: hooks/post_gen_project.py
# - Copier: aegis/core/copier_manager.py and aegis/core/copier_updater.py
# This ensures consistent behavior and proper working directory control.

# Files/directories to exclude from generation
# NOTE: Component-specific file exclusions are handled by post_gen_tasks.py
# This ensures consistent behavior between Cookiecutter and Copier templates.
# Jinja2 conditionals don't work in _exclude when copier.yml is at repo root.
_exclude:
  # Template configuration files (don't copy to generated project)
  - "copier.yml"
  # NOTE: Do NOT exclude .copier-answers.yml - it's needed for updates!

  # Other template engine directories (Copier uses _subdirectory to find its template)
  - "aegis/templates/cookiecutter-aegis-project/"
  - "aegis/templates/cookiecutter-aegis-project/**"

  # Python artifacts
  - "__pycache__"
  - "*.pyc"

  # Version control (don't nest .git)
  - ".git"

  # macOS artifacts
  - ".DS_Store"

  # Validation directory (template testing only)
  - "clean-validation"
