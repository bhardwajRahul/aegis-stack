# Copier template configuration for Aegis Stack
# This replaces cookiecutter.json with more powerful features:
# - Questions with validation
# - Conditional questions
# - Better defaults
# - Update support

_min_copier_version: "9.0.0"

# Answers file to track component selections for updates
_answers_file: .copier-answers.yml

# Template directory name (Copier will generate {{project_slug}} directory automatically)
_templates_suffix: .jinja

# Project metadata
project_name:
  type: str
  help: "Name of your Aegis Stack project"
  default: "My Aegis Stack Project"

project_slug:
  type: str
  help: "Project slug (auto-generated from name)"
  default: "{{ project_name.lower().replace(' ', '-').replace('_', '-') }}"

project_description:
  type: str
  help: "Brief description of your project"
  default: "A production-ready async Python application built with Aegis Stack"

author_name:
  type: str
  help: "Your name"
  default: "Your Name"

author_email:
  type: str
  help: "Your email address"
  default: "your.email@example.com"

github_username:
  type: str
  help: "Your GitHub username"
  default: "your-username"

version:
  type: str
  help: "Initial version"
  default: "0.1.0"

python_version:
  type: str
  help: "Python version to use"
  default: "3.11"
  choices:
    - "3.11"
    - "3.12"
    - "3.13"

# Component selection
include_scheduler:
  type: bool
  help: "Include APScheduler for scheduled tasks?"
  default: false

include_redis:
  type: bool
  help: "Include Redis for caching and pub/sub?"
  default: false

include_worker:
  type: bool
  help: "Include arq worker for background jobs?"
  default: false

include_database:
  type: bool
  help: "Include SQLModel database with SQLite?"
  default: false

include_cache:
  type: bool
  help: "Include Redis cache component?"
  default: false

scheduler_backend:
  type: str
  help: "Scheduler backend storage"
  default: "memory"
  choices:
    - "memory"
    - "sqlite"
  when: "{{ include_scheduler }}"

scheduler_with_persistence:
  type: bool
  help: "Enable scheduler persistence?"
  default: "{{ scheduler_backend == 'sqlite' }}"
  when: "{{ include_scheduler }}"

# Service selection
include_auth:
  type: bool
  help: "Include authentication service with JWT?"
  default: false

include_ai:
  type: bool
  help: "Include AI service with PydanticAI?"
  default: false

ai_providers:
  type: str
  help: "AI providers to support (comma-separated)"
  default: "openai"
  when: "{{ include_ai }}"

# Internal computed values (using Jinja2)
_has_additional_components: "{{ include_scheduler or include_redis or include_worker or include_database or include_cache }}"
_include_migrations: "{{ include_auth }}"

# Component-specific dependencies (computed)
_scheduler_deps: "{% if include_scheduler %}apscheduler>=3.10.0{% endif %}"
_redis_deps: "{% if include_redis %}redis>=5.0.0{% endif %}"
_worker_deps: "{% if include_worker %}arq>=0.25.0{% endif %}"
_database_deps: "{% if include_database %}sqlmodel>=0.0.14,sqlalchemy>=2.0.0,aiosqlite>=0.19.0{% endif %}"
_cache_deps: "{% if include_cache %}redis[hiredis]>=5.0.0{% endif %}"

# Service-specific dependencies (computed)
_auth_deps: "{% if include_auth %}python-jose[cryptography]==3.3.0,passlib[bcrypt]==1.7.4,python-multipart==0.0.9{% endif %}"
_ai_deps: "{% if include_ai %}pydantic-ai-slim[{{ ai_providers }}]==1.0.10,httpx>=0.27.0{% endif %}"

# Tasks to run after project generation
# Copier creates the project at {dst_path}/{project_slug}, so cd into it
_tasks:
  # Step 1: Install dependencies with uv (including dev tools like ruff)
  - "cd {{ _copier_conf.dst_path }}/{{ project_slug }} && uv sync --all-extras"

  # Step 2: Copy environment file if it doesn't exist
  - "cd {{ _copier_conf.dst_path }}/{{ project_slug }} && cp .env.example .env"

  # Step 3: Create data directory for database (if auth service included)
  - command: "cd {{ _copier_conf.dst_path }}/{{ project_slug }} && mkdir -p data"
    when: "{{ include_auth }}"

  # Step 4: Run database migrations if auth service is included
  - command: "cd {{ _copier_conf.dst_path }}/{{ project_slug }} && uv run alembic -c alembic/alembic.ini upgrade head"
    when: "{{ include_auth }}"

  # Step 5: Auto-format generated code (CRITICAL for parity with Cookiecutter)
  - "cd {{ _copier_conf.dst_path }}/{{ project_slug }} && make fix"

# Files/directories to exclude from generation based on component selection
_exclude:
  # Template files and config
  - "copier.yml"
  - ".copier-answers.yml"
  - "__pycache__"
  - "*.pyc"
  - ".git"
  - ".DS_Store"
  - "clean-validation"

  # Scheduler component exclusions (when scheduler NOT included at all)
  - "{% if not include_scheduler %}{{ project_slug }}/app/components/scheduler{% endif %}"
  - "{% if not include_scheduler %}{{ project_slug }}/app/entrypoints/scheduler.py{% endif %}"
  - "{% if not include_scheduler %}{{ project_slug }}/tests/components/test_scheduler.py{% endif %}"
  - "{% if not include_scheduler %}{{ project_slug }}/docs/components/scheduler.md{% endif %}"
  - "{% if not include_scheduler %}{{ project_slug }}/app/components/backend/api/scheduler.py{% endif %}"
  - "{% if not include_scheduler %}{{ project_slug }}/tests/api/test_scheduler_endpoints.py{% endif %}"
  - "{% if not include_scheduler %}{{ project_slug }}/app/components/frontend/dashboard/cards/scheduler_card.py{% endif %}"
  - "{% if not include_scheduler %}{{ project_slug }}/tests/services/test_scheduled_task_manager.py{% endif %}"

  # Scheduler memory backend exclusions (when scheduler HAS memory backend, not persistence)
  - "{% if scheduler_backend == 'memory' -%}{{ project_slug }}/app/services/scheduler{% endif %}"
  - "{% if scheduler_backend == 'memory' -%}{{ project_slug }}/app/cli/tasks.py{% endif %}"
  - "{% if scheduler_backend == 'memory' -%}{{ project_slug }}/app/components/backend/api/scheduler.py{% endif %}"
  - "{% if scheduler_backend == 'memory' -%}{{ project_slug }}/tests/api/test_scheduler_endpoints.py{% endif %}"
  - "{% if scheduler_backend == 'memory' -%}{{ project_slug }}/tests/services/test_scheduled_task_manager.py{% endif %}"

  # Worker component exclusions
  - "{% if not include_worker %}{{ project_slug }}/app/components/worker{% endif %}"
  - "{% if not include_worker %}{{ project_slug }}/app/services/load_test.py{% endif %}"
  - "{% if not include_worker %}{{ project_slug }}/app/services/load_test_models.py{% endif %}"
  - "{% if not include_worker %}{{ project_slug }}/app/cli/load_test.py*{% endif %}"
  - "{% if not include_worker %}{{ project_slug }}/app/components/backend/api/worker.py*{% endif %}"
  - "{% if not include_worker %}{{ project_slug }}/tests/api/test_worker_endpoints.py*{% endif %}"
  - "{% if not include_worker %}{{ project_slug }}/tests/services/test_load_test_service.py{% endif %}"
  - "{% if not include_worker %}{{ project_slug }}/tests/services/test_load_test_models.py{% endif %}"
  - "{% if not include_worker %}{{ project_slug }}/tests/services/test_worker_health_registration.py*{% endif %}"

  # Shared component integration tests (exclude only when BOTH scheduler AND worker disabled)
  - "{% if not include_scheduler and not include_worker %}{{ project_slug }}/tests/services/test_component_integration.py{% endif %}"
  - "{% if not include_scheduler and not include_worker %}{{ project_slug }}/tests/services/test_health_logic.py{% endif %}"

  # Database component exclusions
  - "{% if not include_database %}{{ project_slug }}/app/core/db.py*{% endif %}"

  # Auth service exclusions
  - "{% if not include_auth %}{{ project_slug }}/app/services/auth{% endif %}"
  - "{% if not include_auth %}{{ project_slug }}/app/components/backend/api/auth{% endif %}"
  - "{% if not include_auth %}{{ project_slug }}/app/cli/auth.py*{% endif %}"
  - "{% if not include_auth %}{{ project_slug }}/app/models/user.py{% endif %}"
  - "{% if not include_auth %}{{ project_slug }}/app/core/security.py{% endif %}"
  - "{% if not include_auth %}{{ project_slug }}/alembic{% endif %}"
  - "{% if not include_auth %}{{ project_slug }}/tests/api/test_auth_endpoints.py*{% endif %}"
  - "{% if not include_auth %}{{ project_slug }}/tests/services/test_auth_integration.py*{% endif %}"

  # AI service exclusions
  - "{% if not include_ai %}{{ project_slug }}/app/services/ai{% endif %}"
  - "{% if not include_ai %}{{ project_slug }}/app/components/backend/api/ai{% endif %}"
  - "{% if not include_ai %}{{ project_slug }}/app/cli/ai.py*{% endif %}"
  - "{% if not include_ai %}{{ project_slug }}/app/cli/ai_rendering.py{% endif %}"
  - "{% if not include_ai %}{{ project_slug }}/app/cli/marko_terminal_renderer.py{% endif %}"
  - "{% if not include_ai %}{{ project_slug }}/tests/cli/test_ai_rendering.py{% endif %}"
  - "{% if not include_ai %}{{ project_slug }}/tests/cli/test_conversation_memory.py{% endif %}"
  - "{% if not include_ai %}{{ project_slug }}/tests/services/test_conversation_persistence.py{% endif %}"
  - "{% if not include_ai %}{{ project_slug }}/tests/services/ai{% endif %}"

  # Frontend dashboard cards (conditional)
  - "{% if not include_scheduler %}{{ project_slug }}/app/components/frontend/dashboard/cards/scheduler_card.py{% endif %}"
  - "{% if not include_worker %}{{ project_slug }}/app/components/frontend/dashboard/cards/worker_card.py{% endif %}"
