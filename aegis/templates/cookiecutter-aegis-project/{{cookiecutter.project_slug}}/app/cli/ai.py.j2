"""
AI service CLI commands.

Command-line interface for AI service management and chat functionality.
"""

import typer
from rich.console import Console
from rich.table import Table

from ..core.config import settings
from ..services.ai.config import get_ai_config
from ..services.ai.models import (
    AIProvider,
    MessageRole,
    get_free_providers,
    get_provider_capabilities,
)

app = typer.Typer(help="AI service management and chat commands")
console = Console()

# Configuration command group
config_app = typer.Typer(help="AI service configuration commands")
app.add_typer(config_app, name="config")

# Provider command group
providers_app = typer.Typer(help="AI provider management commands")
app.add_typer(providers_app, name="providers")


@app.command()
def version() -> None:
    """Show AI service version and configuration."""
    ai_config = get_ai_config(settings)

    typer.echo("ü§ñ AI Service Configuration System")
    typer.echo("Engine: PydanticAI")
    typer.echo(f"Status: {'‚úÖ Enabled' if ai_config.enabled else '‚ùå Disabled'}")
    typer.echo(f"Provider: {ai_config.provider}")
    typer.echo(f"Model: {ai_config.model}")
    typer.echo("")
    typer.echo("Available commands:")
    typer.echo("  ‚Ä¢ ai chat \"message\"       - Send a chat message")
    typer.echo("  ‚Ä¢ ai chat list           - List conversations")
    typer.echo("  ‚Ä¢ ai chat history <id>   - View conversation history")
    typer.echo("  ‚Ä¢ ai config show         - Show detailed configuration")
    typer.echo("  ‚Ä¢ ai config validate     - Validate current configuration")
    typer.echo("  ‚Ä¢ ai providers list      - List available providers")


# Chat command group
chat_app = typer.Typer(help="AI chat commands")
app.add_typer(chat_app, name="chat")


@app.command()
def chat(
    message: str = typer.Argument(..., help="Message to send to AI"),
    conversation_id: str | None = typer.Option(
        None, "--conversation-id", "-c", help="Conversation ID"
    ),
) -> None:
    """Send a chat message (shortcut for ai chat send)."""
    import asyncio
    from app.services.ai.service import AIService

    ai_service = AIService(settings)

    async def send_message() -> None:
        try:
            response = await ai_service.chat(
                message=message,
                conversation_id=conversation_id,
                user_id="cli-user"
            )

            typer.echo(f"ü§ñ {response.content}")

        except Exception as e:
            typer.echo(f"‚ùå Error: {e}", err=True)
            raise typer.Exit(1)

    asyncio.run(send_message())


@chat_app.command("send")
def chat_send(
    message: str = typer.Argument(..., help="Message to send to AI"),
    conversation_id: str | None = typer.Option(
        None, "--conversation-id", "-c", help="Conversation ID"
    ),
    user_id: str = typer.Option("cli-user", "--user-id", "-u", help="User identifier"),
) -> None:
    """Send a chat message and get AI response."""
    import asyncio
    from app.services.ai.service import AIService

    ai_service = AIService(settings)

    async def send_message() -> None:
        try:
            response = await ai_service.chat(
                message=message,
                conversation_id=conversation_id,
                user_id=user_id
            )

            # Show conversation info
            conv_id = response.metadata.get("conversation_id", "unknown")
            conversation = ai_service.get_conversation(conv_id)
            if conversation:
                typer.echo(f"üí¨ Conversation: {conversation.id}")
                if conversation.title:
                    typer.echo(f"üìù Title: {conversation.title}")

            typer.echo("")
            typer.echo(f"ü§ñ {response.content}")

            # Show response metadata
            if conversation:
                typer.echo("")
                typer.echo(f"‚ÑπÔ∏è  Messages: {conversation.get_message_count()}")
                if "last_response_time_ms" in conversation.metadata:
                    response_time = conversation.metadata["last_response_time_ms"]
                    typer.echo(f"‚è±Ô∏è  Response time: {response_time:.1f}ms")

        except Exception as e:
            typer.echo(f"‚ùå Error: {e}", err=True)
            raise typer.Exit(1)

    asyncio.run(send_message())


@chat_app.command("list")
def chat_list(
    user_id: str = typer.Option("cli-user", "--user-id", "-u", help="User identifier"),
    limit: int = typer.Option(
        10, "--limit", "-l", help="Number of conversations to show"
    ),
) -> None:
    """List conversations for a user."""
    from app.services.ai.service import AIService

    ai_service = AIService(settings)
    conversations = ai_service.list_conversations(user_id)[:limit]

    if not conversations:
        typer.echo(f"No conversations found for user: {user_id}")
        return

    typer.echo(f"üí¨ Conversations for {user_id}:")
    typer.echo("")

    for conv in conversations:
        title = conv.title or "Untitled"
        messages = conv.get_message_count()
        updated = conv.updated_at.strftime("%Y-%m-%d %H:%M")

        typer.echo(f"‚Ä¢ {conv.id[:8]}... - {title}")
        typer.echo(f"  üìä {messages} messages | üïí {updated}")
        typer.echo("")


@chat_app.command("history")
def chat_history(
    conversation_id: str = typer.Argument(..., help="Conversation ID"),
    user_id: str = typer.Option("cli-user", "--user-id", "-u", help="User identifier"),
) -> None:
    """View conversation history."""
    from app.services.ai.service import AIService

    ai_service = AIService(settings)
    conversation = ai_service.get_conversation(conversation_id)

    if not conversation:
        typer.echo(f"‚ùå Conversation not found: {conversation_id}")
        raise typer.Exit(1)

    # Check if user owns conversation
    if conversation.metadata.get("user_id") != user_id:
        typer.echo("‚ùå Access denied: You don't own this conversation")
        raise typer.Exit(1)

    typer.echo(f"üí¨ Conversation: {conversation_id}")
    if conversation.title:
        typer.echo(f"üìù Title: {conversation.title}")
    typer.echo(f"ü§ñ Provider: {conversation.provider}")
    typer.echo(f"üìä Messages: {conversation.get_message_count()}")
    typer.echo("")

    for i, message in enumerate(conversation.messages):
        timestamp = message.timestamp.strftime("%H:%M:%S")
        role_icon = "üë§" if message.role == MessageRole.USER else "ü§ñ"

        typer.echo(f"{role_icon} [{timestamp}] {message.content}")
        if i < len(conversation.messages) - 1:
            typer.echo("")


@config_app.command("show")
def config_show() -> None:
    """Show detailed AI service configuration."""
    ai_config = get_ai_config(settings)

    typer.echo("üîß AI Service Configuration")
    typer.echo("=" * 40)
    typer.echo(f"Enabled: {ai_config.enabled}")
    typer.echo(f"Provider: {ai_config.provider}")
    typer.echo(f"Model: {ai_config.model}")
    typer.echo(f"Temperature: {ai_config.temperature}")
    typer.echo(f"Max Tokens: {ai_config.max_tokens}")
    typer.echo(f"Timeout: {ai_config.timeout_seconds}s")

    # Provider-specific configuration
    provider_config = ai_config.get_provider_config(settings)
    typer.echo(f"\nüîê Provider Configuration ({ai_config.provider}):")
    typer.echo(f"API Key: {'‚úÖ Set' if provider_config.api_key else '‚ùå Not set'}")
    typer.echo(f"Rate Limit: {provider_config.rate_limit_rpm} RPM")

    # Available providers
    available = ai_config.get_available_providers(settings)
    typer.echo(f"\n‚úÖ Available Providers ({len(available)}):")
    for provider in available:
        typer.echo(f"  ‚Ä¢ {provider}")


@config_app.command("validate")
def config_validate() -> None:
    """Validate AI service configuration."""
    ai_config = get_ai_config(settings)

    typer.echo("üîç Validating AI Service Configuration...")

    errors = ai_config.validate_configuration(settings)

    if not errors:
        typer.echo("‚úÖ Configuration is valid!")
        typer.echo(f"   Provider: {ai_config.provider}")
        typer.echo(f"   Model: {ai_config.model}")

        # Show provider capabilities
        capabilities = get_provider_capabilities(ai_config.provider)
        if capabilities.free_tier_available:
            typer.echo("   üí∞ Uses free tier")
        else:
            typer.echo("   üí≥ Requires paid account")

    else:
        typer.echo("‚ùå Configuration has issues:")
        for error in errors:
            typer.echo(f"   ‚Ä¢ {error}")

        # Suggest free providers if API key issues
        if any("API key" in error for error in errors):
            free_providers = get_free_providers()
            if free_providers:
                providers_list = ', '.join(free_providers)
                typer.echo(f"\nüí° Try these free providers: {providers_list}")


@config_app.command("set-provider")
def config_set_provider(
    provider: str = typer.Argument(
        ..., help="Provider name (openai, anthropic, google, groq, mistral, cohere)"
    )
):
    """Set the primary AI provider."""
    try:
        ai_provider = AIProvider(provider.lower())
    except ValueError:
        typer.echo(f"‚ùå Unknown provider: {provider}")
        typer.echo(f"Available providers: {', '.join([p.value for p in AIProvider])}")
        raise typer.Exit(1)

    typer.echo(f"üîÑ Setting provider to: {ai_provider}")
    typer.echo("To persist this change, update your .env file:")
    typer.echo(f"AI_PROVIDER={ai_provider}")

    # Show provider info
    capabilities = get_provider_capabilities(ai_provider)
    if capabilities.free_tier_available:
        typer.echo("‚úÖ This provider offers a free tier")
    else:
        typer.echo("üí≥ This provider requires a paid account")
        typer.echo(f"   Set {ai_provider.upper()}_API_KEY in your environment")


@providers_app.command("list")
def providers_list() -> None:
    """List all available AI providers."""
    ai_config = get_ai_config(settings)
    available = ai_config.get_available_providers(settings)
    free_providers = get_free_providers()

    table = Table(title="ü§ñ AI Providers", width=75)
    table.add_column("Provider", style="cyan", width=9)
    table.add_column("Status", style="green", width=26, no_wrap=True)
    table.add_column("Free", style="yellow", width=4)
    table.add_column("Features", style="blue", width=18)

    for provider in AIProvider:
        capabilities = get_provider_capabilities(provider)
        is_available = provider in available
        is_current = provider == ai_config.provider

        if is_available:
            status = "‚úÖ Available"
        else:
            # Make status more informative about what's missing
            if provider == AIProvider.PUBLIC:
                status = "‚ùå Error"  # Shouldn't happen for PUBLIC
            else:
                # Show abbreviated environment variable name
                env_var = f"{provider.value.upper()}_API_KEY"
                status = f"‚ùå Need {env_var}"

        if is_current:
            status += " (current)"

        free_tier = "Yes" if provider in free_providers else "No"

        features = []
        if capabilities.supports_streaming:
            features.append("Stream")
        if capabilities.supports_function_calling:
            features.append("Functions")
        if capabilities.supports_vision:
            features.append("Vision")

        table.add_row(
            provider.value,
            status,
            free_tier,
            ", ".join(features) if features else "Basic"
        )

    console.print(table)




if __name__ == "__main__":
    app()
