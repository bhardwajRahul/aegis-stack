name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5
    
    - name: Install uv
      uses: astral-sh/setup-uv@v6
      with:
        enable-cache: true
        cache-dependency-glob: "uv.lock"
    
    - name: Set up Python
      run: uv python install 3.11
    
    - name: Install dependencies
      run: uv sync --all-extras
    
    - name: Run linting
      run: uv run ruff check .

  typecheck:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5
    
    - name: Install uv
      uses: astral-sh/setup-uv@v6
      with:
        enable-cache: true
        cache-dependency-glob: "uv.lock"
    
    - name: Set up Python
      run: uv python install 3.11
    
    - name: Install dependencies
      run: uv sync --all-extras
    
    - name: Run type checking
      run: uv run ty check

  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5
    
    - name: Install uv
      uses: astral-sh/setup-uv@v6
      with:
        enable-cache: true
        cache-dependency-glob: "uv.lock"
    
    - name: Set up Python
      run: uv python install 3.11
    
    - name: Install dependencies
      run: uv sync --all-extras
    
    - name: Run tests
      run: uv run pytest -v -m "not slow"

  test-uvx:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5
    
    - name: Install uv
      uses: astral-sh/setup-uv@v6
      with:
        enable-cache: true
    
    - name: Test uvx aegis help
      run: uvx --from . aegis --help
    
    - name: Test uvx aegis-stack help
      run: uvx --from . aegis-stack --help
    
    - name: Test project creation with uvx aegis
      run: |
        uvx --from . aegis init test-uvx-aegis --no-interactive --yes --force
        test -d test-uvx-aegis
        test -f test-uvx-aegis/pyproject.toml
    
    - name: Test project creation with uvx aegis-stack
      run: |
        uvx --from . aegis-stack init test-uvx-aegis-stack --no-interactive --yes --force
        test -d test-uvx-aegis-stack
        test -f test-uvx-aegis-stack/pyproject.toml
    
    - name: Verify generated project structure
      run: |
        cd test-uvx-aegis
        test -d app/components/backend
        test -d app/components/frontend
        test -f app/entrypoints/webserver.py

  template-parity:
    runs-on: ubuntu-latest
    continue-on-error: true  # Non-blocking until Copier template is fixed
    steps:
    - uses: actions/checkout@v5

    - name: Install uv
      uses: astral-sh/setup-uv@v6
      with:
        enable-cache: true
        cache-dependency-glob: "uv.lock"

    - name: Set up Python
      run: uv python install 3.11

    - name: Install dependencies
      run: uv sync --all-extras

    - name: Run template parity tests
      run: uv run pytest tests/test_template_parity.py -v
      # Note: Tests are currently skipped (@pytest.mark.skip) because Copier
      # template needs conditional _exclude patterns added. This job validates
      # the CI infrastructure is ready. Once Copier template is fixed, remove
      # the skip decorator and this will become an active validation step.

